<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Riccardo Trabucchi - magazzino vocale</title>
    <!-- Caricamento Tailwind CSS per lo stile moderno e responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icone Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Animazione pulsante microfono attivo */
        .listening-pulse {
            animation: pulse-red 1.5s infinite;
            color: #ef4444 !important;
        }
        @keyframes pulse-red {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        /* Nasconde la scrollbar su tutti i browser */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 font-sans h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- Header Fisso -->
    <header class="bg-slate-900 text-white p-4 shadow-lg flex justify-between items-center shrink-0 z-20">
        <div>
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i class="fas fa-box-open text-amber-400"></i> Magazzino Vocale
            </h1>
            <p class="text-[10px] text-slate-400 uppercase tracking-wider" id="totalItems">0 Posizioni</p>
        </div>
        <div class="flex gap-2">
            <!-- Pulsanti Backup/Restore -->
            <button onclick="exportData()" title="Scarica Backup" class="w-8 h-8 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center transition border border-slate-700">
                <i class="fas fa-download text-xs"></i>
            </button>
            <label for="fileInput" title="Carica Backup" class="w-8 h-8 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center transition border border-slate-700 cursor-pointer">
                <i class="fas fa-upload text-xs"></i>
            </label>
            <input type="file" id="fileInput" class="hidden" onchange="importData(this)" accept=".json">
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-4 space-y-5 no-scrollbar pb-32">

        <!-- Card Inserimento / Modifica -->
        <div class="bg-white p-5 rounded-2xl shadow-lg border border-slate-200 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-1 h-full bg-amber-500"></div>
            
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest">INSERIMENTO (Voce / Testo)</h2>
                <button onclick="clearInputs()" class="text-xs text-amber-600 hover:text-amber-700 font-medium">Pulisci campi</button>
            </div>
            
            <div class="space-y-4">
                
                <!-- Input Nome Componente -->
                <div class="relative group">
                    <label class="block text-[10px] font-bold text-slate-400 mb-1 ml-1">NOME COMPONENTE</label>
                    <input type="text" id="itemName" placeholder="es. Resistenza" 
                           class="w-full pl-4 pr-10 py-3 rounded-xl bg-slate-50 border-2 border-slate-100 focus:border-amber-400 focus:bg-white focus:outline-none font-semibold text-lg transition-colors placeholder-slate-300">
                    <button onclick="startDictation('itemName')" id="mic-itemName" title="Inserisci il nome tramite microfono" class="absolute right-3 top-8 text-slate-400 hover:text-red-500 transition p-1">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>

                <!-- Input Posizione (Cassetto) -->
                <div class="relative">
                    <label class="block text-[10px] font-bold text-slate-400 mb-1 ml-1">POSIZIONE (CASSETTO / SCAFFALE)</label>
                    <input type="text" id="itemLoc" placeholder="es. 32" 
                           class="w-full pl-4 pr-10 py-3 rounded-xl bg-slate-50 border-2 border-slate-100 focus:border-blue-400 focus:bg-white focus:outline-none font-mono font-bold text-slate-700 text-lg transition-colors uppercase">
                    <button onclick="startDictation('itemLoc')" id="mic-itemLoc" title="Inserisci la posizione tramite microfono" class="absolute right-3 top-8 text-slate-400 hover:text-red-500 transition p-1">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>

                <!-- Pulsanti Azione -->
                <div class="pt-2 flex gap-2">
                    <button onclick="saveItem()" class="flex-1 bg-slate-800 hover:bg-slate-900 active:scale-[0.98] text-white py-3 rounded-xl font-bold shadow-lg shadow-slate-200 transition-all flex justify-center items-center gap-2">
                        <i class="fas fa-save"></i> SALVA / AGGIORNA
                    </button>
                    <button id="btnDelete" onclick="deleteItem()" title="Elimina l'elemento selezionato" class="hidden w-12 bg-red-50 text-red-500 rounded-xl hover:bg-red-100 transition flex justify-center items-center border border-red-100">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Barra di Ricerca e Lista -->
        <div>
            <div class="sticky top-0 bg-slate-50 pt-2 pb-3 z-10 backdrop-blur-sm bg-opacity-90">
                <div class="relative shadow-md group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-slate-300 group-focus-within:text-amber-500 transition"></i>
                    </div>
                    <input type="text" id="searchBar" onkeyup="filterList()" 
                           class="block w-full pl-10 pr-10 py-3 border-none rounded-2xl bg-white focus:ring-2 focus:ring-amber-400 focus:outline-none text-sm shadow-inner transition-all" 
                           placeholder="Cerca (Voce o Testo) per nome o posizione...">
                    <button onclick="startDictation('searchBar')" id="mic-searchBar" title="Cerca tramite microfono" class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer text-slate-300 hover:text-red-500 transition">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
            </div>

            <!-- Contenitore Lista -->
            <div id="inventoryList" class="space-y-3 pb-20">
                <!-- Javascript riempirà qui -->
            </div>
        </div>

    </main>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl text-sm font-medium transition-all opacity-0 translate-y-[-20px] pointer-events-none z-50 flex items-center gap-2">
        <i class="fas fa-check-circle text-amber-400"></i> <span id="toastMsg">Messaggio</span>
    </div>

    <!-- Custom Modal per rimpiazzare confirm() -->
    <div id="customModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] transition-opacity duration-300 opacity-0 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-xs w-full transform scale-95 transition-transform duration-300">
            <p id="modalMessage" class="text-slate-800 text-center mb-6 font-medium"></p>
            <div class="flex justify-between gap-4">
                <button id="modalCancel" class="flex-1 py-2 rounded-lg text-slate-600 bg-slate-100 hover:bg-slate-200 transition font-semibold">Annulla</button>
                <button id="modalConfirm" class="flex-1 py-2 rounded-lg text-white bg-red-600 hover:bg-red-700 transition font-semibold">Conferma</button>
            </div>
        </div>
    </div>


    <script>
        // --- STATO E INIZIALIZZAZIONE ---
        let inventory = [];
        // Nuova chiave per evitare conflitti con vecchie versioni
        const DB_KEY = 'WarehouseDB_v5_TTS_simple'; 

        window.onload = function() {
            const saved = localStorage.getItem(DB_KEY);
            if (saved) {
                inventory = JSON.parse(saved);
            }
            renderList();
        };

        // --- CORE LOGIC: CRUD ---

        function saveItem() {
            const name = document.getElementById('itemName').value.trim();
            // Forza la posizione in maiuscolo per standardizzazione
            const loc = document.getElementById('itemLoc').value.trim().toUpperCase(); 

            if (!name || !loc) {
                showToast("Devi inserire Nome e Posizione!", true);
                return;
            }

            // Normalizza il nome (es. "vite m4" -> "Vite M4")
            const normalizedName = name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();

            // Cerca se esiste già (per nome non case-sensitive)
            const index = inventory.findIndex(item => item.name.toLowerCase() === normalizedName.toLowerCase());

            const newItem = {
                name: normalizedName,
                loc: loc,
                updated: Date.now()
            };

            if (index !== -1) {
                // Aggiorna esistente
                inventory[index] = newItem;
                showToast(`Posizione aggiornata per: ${newItem.name}`);
            } else {
                // Nuovo elemento
                inventory.push(newItem);
                showToast(`Salvato: ${newItem.name}`);
            }

            saveDB();
            clearInputs();
            renderList();
        }

        function deleteItem() {
            const name = document.getElementById('itemName').value.trim();
            if(!name) return;

            // Uso di una modale custom invece di confirm()
            showConfirmationModal(`Vuoi rimuovere definitivamente "${name}"?`, () => {
                inventory = inventory.filter(item => item.name.toLowerCase() !== name.toLowerCase());
                saveDB();
                clearInputs();
                renderList();
                showToast("Oggetto eliminato");
            });
        }

        function saveDB() {
            localStorage.setItem(DB_KEY, JSON.stringify(inventory));
            updateCount();
        }

        // --- UI & RENDERING ---

        function renderList(filterText = "") {
            const listEl = document.getElementById('inventoryList');
            listEl.innerHTML = "";
            
            const search = filterText.toLowerCase();
            // Filtra per nome o posizione, poi ordina per nome
            const filtered = inventory.filter(item => 
                item.name.toLowerCase().includes(search) || 
                item.loc.toLowerCase().includes(search)
            ).sort((a, b) => a.name.localeCompare(b.name));

            if (filtered.length === 0) {
                listEl.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 text-slate-300">
                        <i class="fas fa-search text-4xl mb-3 opacity-50"></i>
                        <p class="text-sm font-medium">Nessun risultato trovato ${filterText ? `per "${filterText}"` : ""}</p>
                    </div>`;
                return;
            }

            filtered.forEach(item => {
                const initial = item.name.charAt(0).toUpperCase();
                
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center cursor-pointer active:scale-[0.99] transition-transform hover:border-amber-200 group";
                card.onclick = () => loadItem(item);
                
                card.innerHTML = `
                    <div class="flex items-center gap-4 overflow-hidden">
                        <div class="h-10 w-10 min-w-[2.5rem] rounded-full bg-slate-100 text-slate-500 font-bold flex items-center justify-center group-hover:bg-amber-100 group-hover:text-amber-600 transition-colors">
                            ${initial}
                        </div>
                        <div class="truncate">
                            <h3 class="font-bold text-slate-700 text-base leading-tight truncate">${item.name}</h3>
                            <p class="text-xs text-slate-400 mt-0.5">Aggiornato: ${new Date(item.updated).toLocaleDateString()}</p>
                        </div>
                    </div>
                    <div class="pl-2">
                         <span class="bg-blue-600 text-white font-mono font-bold px-4 py-2 rounded-lg text-sm shadow-md whitespace-nowrap">
                            ${item.loc}
                        </span>
                    </div>
                `;
                listEl.appendChild(card);
            });
            updateCount();
        }

        function loadItem(item) {
            // Blocca la sintesi vocale se sta parlando
            window.speechSynthesis.cancel(); 

            // Carica i dati nei campi di input
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemLoc').value = item.loc;
            
            // Abilita il pulsante Elimina
            document.getElementById('btnDelete').classList.remove('hidden');
            
            // Fai lo scroll verso l'alto per l'editing
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // FUNZIONE CHIAVE: Legge a voce alta la posizione
            speakLocation(item.loc);
        }

        function clearInputs() {
            document.getElementById('itemName').value = "";
            document.getElementById('itemLoc').value = "";
            document.getElementById('btnDelete').classList.add('hidden');
            document.getElementById('searchBar').value = "";
            window.speechSynthesis.cancel(); // Silenzia la voce
            renderList(); 
        }

        function filterList() {
            renderList(document.getElementById('searchBar').value);
        }

        function updateCount() {
            document.getElementById('totalItems').innerText = `${inventory.length} POSIZIONI REGISTRATE`;
        }
        
        // --- FUNZIONI DI SERVIZIO E MODALE ---

        // Custom Modal UI per rimpiazzare alert/confirm
        function showConfirmationModal(message, onConfirm) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalMessage').innerText = message;
            
            const confirmBtn = document.getElementById('modalConfirm');
            const cancelBtn = document.getElementById('modalCancel');

            const closeModal = () => {
                modal.classList.add('opacity-0');
                modal.querySelector('div').classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 300);
                confirmBtn.onclick = null; 
                cancelBtn.onclick = null;
            };

            confirmBtn.onclick = () => {
                closeModal();
                onConfirm();
            };

            cancelBtn.onclick = closeModal;

            // Mostra la modale
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-95');
            }, 10);
        }

        function showToast(msg, isError = false, type = 'check') {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            
            if(isError) {
                t.querySelector('i').className = "fas fa-exclamation-circle text-red-400";
            } else if (type === 'tts') {
                t.querySelector('i').className = "fas fa-volume-up text-blue-400";
            } else {
                t.querySelector('i').className = "fas fa-check-circle text-amber-400";
            }

            t.classList.remove('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => {
                t.classList.add('opacity-0', 'translate-y-[-20px]');
            }, 3000);
        }
        
        // --- OUTPUT VOCALE (TTS) ---

        function speakLocation(location) {
            if (!('speechSynthesis' in window)) {
                showToast("Sintesi Vocale non supportata dal tuo browser.", true);
                return;
            }
            if (window.location.protocol === 'file:') {
                 showToast("Sintesi Vocale bloccata: i browser richiedono HTTPS per questa funzione.", true);
                 return;
            }

            // Annulla ogni discorso precedente e inizia il nuovo
            window.speechSynthesis.cancel(); 

            // Sceglie la voce italiana, se disponibile
            let utterance = new SpeechSynthesisUtterance();
            utterance.text = `Il componente si trova nella posizione: ${location}.`;
            utterance.lang = 'it-IT';
            
            // Opzionale: cerca una voce italiana specifica per un tono migliore
            let voices = window.speechSynthesis.getVoices();
            let italianVoice = voices.find(voice => voice.lang === 'it-IT' || voice.lang === 'it_IT');
            if (italianVoice) {
                utterance.voice = italianVoice;
            } else {
                 console.warn("Voce italiana non trovata, usando la voce di default.");
            }

            window.speechSynthesis.speak(utterance);
            showToast(`La voce dice: Posizione ${location}`, false, 'tts');
        }


        // --- INPUT VOCALE (Microfono) ---
        function startDictation(targetId) {
            // Controlla il supporto e avvisa l'utente se si è in locale
            if (!('webkitSpeechRecognition' in window)) {
                showToast("Il tuo browser non supporta l'Input Vocale.", true);
                return;
            }
            if (window.location.protocol === 'file:') {
                 showToast("Microfono bloccato: i browser richiedono HTTPS (indirizzo web sicuro) per questa funzione.", true);
                 return;
            }

            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'it-IT';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            const btn = document.getElementById('mic-' + targetId);
            const inputEl = document.getElementById(targetId);

            recognition.onstart = () => {
                btn.classList.add('listening-pulse');
                showToast("Ascolto in corso...", false);
            };
            recognition.onend = () => btn.classList.remove('listening-pulse');
            recognition.onerror = (e) => {
                 btn.classList.remove('listening-pulse');
                 console.error("Errore Microfono:", e.error);
                 showToast("Errore Microfono o permesso negato.", true);
            };

            recognition.onresult = (e) => {
                let text = e.results[0][0].transcript;
                if(text.endsWith('.')) text = text.slice(0, -1);
                
                // Pulizia specifica per la Posizione
                if(targetId === 'itemLoc') {
                    // Rimuove spazi e forza maiuscolo per standardizzare le sigle dei cassetti (es. "a 12" -> "A12")
                    text = text.replace(/\s+/g, '').toUpperCase();
                }
                
                inputEl.value = text;

                // Se l'input è la ricerca, filtra subito la lista
                if(targetId === 'searchBar') {
                    filterList();
                } 
                // Se è un campo di inserimento, sposta il focus all'altro campo per velocizzare l'inserimento vocale
                else if (targetId === 'itemName') {
                    document.getElementById('itemLoc').focus();
                } else if (targetId === 'itemLoc') {
                    document.getElementById('itemName').focus();
                }
            };
            recognition.start();
        }

        // --- BACKUP & RESTORE ---
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(inventory));
            const a = document.createElement('a');
            a.href = dataStr;
            a.download = `magazzino_vocale_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            showToast("Backup scaricato.");
        }

        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(Array.isArray(data)) {
                        // Uso della modale custom al posto di confirm()
                        showConfirmationModal("Sovrascrivere tutti i dati correnti con questo backup?", () => {
                            inventory = data.map(item => ({
                                name: item.name,
                                loc: item.loc,
                                updated: item.updated || Date.now()
                            }));
                            saveDB();
                            renderList();
                            showToast("Backup ripristinato!");
                        });
                    }
                } catch(err) {
                     showToast("Errore nel file di backup. Assicurati sia un JSON valido.", true);
                }
            };
            reader.readAsText(file);
            input.value = "";
        }
    </script>
</body>
</html>
